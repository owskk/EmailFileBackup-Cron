{% extends "base.html" %}

{% block title %}Index of {{ display_path }}{% endblock %}

{% block content %}
<div class="page-header">
    <div style="width: 100%;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
            <h1 class="page-title">文件浏览器</h1>
            <div style="position: relative; width: 250px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">
                    <circle cx="11" cy="11" r="8" />
                    <line x1="21" x2="16.65" y1="21" y2="16.65" />
                </svg>
                <input type="text" id="search" class="form-control" placeholder="搜索..." autocomplete="off"
                    style="padding-left: 2.25rem;">
            </div>
        </div>

        <!-- Breadcrumb -->
        <div class="breadcrumb"
            style="display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem; font-size: 0.95rem; color: var(--text-secondary);">
            <a href="/" style="display: flex; align-items: center; gap: 0.25rem; color: var(--text-muted);">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                    <polyline points="9 22 9 12 15 12 15 22" />
                </svg>
            </a>
            <span style="color: var(--text-muted);">/</span>

            {% if not is_root %}
            <a href="{{ url_for('webdav_index') }}" style="font-weight: 500; color: var(--primary-color);">文件服务器</a>
            {% endif %}

            {% if display_path != '/' %}
            {% set parts = display_path.strip('/').split('/') %}
            {% if parts %}
            {% for part in parts %}
            <span style="color: var(--text-muted);">/</span>
            {% set subpath = parts[:loop.index]|join('/') %}
            <a href="{{ url_for('webdav_index', subpath=subpath) }}"
                style="font-weight: 500; color: var(--primary-color);">{{ part }}</a>
            {% endfor %}
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<div class="card" style="padding: 0; overflow: hidden;">
    <div class="table-container" style="border: none; border-radius: 0;">
        <table class="table" id="file-table">
            <thead>
                <tr>
                    <th style="width: 40px;"></th>
                    <th>文件名</th>
                    <th style="width: 120px; text-align: right;">大小</th>
                    <th style="width: 180px; text-align: right;">修改时间</th>
                    <th style="width: 60px;"></th>
                </tr>
            </thead>
            <tbody>
                {% if parent_path is not none %}
                <tr class="parent-dir">
                    <td style="text-align: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                            fill="currentColor" style="color: #fbbf24;">
                            <path
                                d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z" />
                        </svg>
                    </td>
                    {% if parent_path == '' %}
                    <td><a href="{{ url_for('webdav_index') }}" style="font-weight: 600;">..</a></td>
                    {% else %}
                    <td><a href="{{ url_for('webdav_index', subpath=parent_path) }}" style="font-weight: 600;">..</a>
                    </td>
                    {% endif %}
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                {% endif %}

                {% for item in files %}
                <tr class="file-row">
                    <td style="text-align: center;">
                        {% if item.isdir %}
                        {% if item.is_server_root %}
                        <!-- Server Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            style="color: var(--accent-color);">
                            <rect x="2" y="2" width="20" height="8" rx="2" ry="2" />
                            <rect x="2" y="14" width="20" height="8" rx="2" ry="2" />
                            <line x1="6" x2="6.01" y1="6" y2="6" />
                            <line x1="6" x2="6.01" y1="18" y2="18" />
                        </svg>
                        {% else %}
                        <!-- Folder Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                            fill="currentColor" style="color: #fbbf24;">
                            <path
                                d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z" />
                        </svg>
                        {% endif %}
                        {% else %}
                        <!-- File Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            style="color: var(--text-muted);">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                            <polyline points="14 2 14 8 20 8" />
                        </svg>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('webdav_index', subpath=item.display_path) if item.isdir else url_for('webdav_download', subpath=item.display_path) }}"
                            class="file-link" data-name="{{ item.name }}"
                            style="font-weight: 500; color: var(--text-primary);">
                            {{ item.name }}
                        </a>
                    </td>
                    <td style="text-align: right; color: var(--text-secondary); font-family: var(--font-mono);">{{
                        item.size_str }}</td>
                    <td style="text-align: right; color: var(--text-muted); font-family: var(--font-mono);">{{
                        item.mtime }}</td>
                    <td style="text-align: center;">
                        {% if not item.isdir %}
                        <a href="{{ url_for('webdav_download', subpath=item.display_path) }}" title="Download" download
                            style="color: var(--text-muted); padding: 4px; border-radius: 4px; display: inline-block;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="7 10 12 15 17 10" />
                                <line x1="12" x2="12" y1="15" y2="3" />
                            </svg>
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const searchInput = document.getElementById('search');
    if (searchInput) {
        searchInput.addEventListener('input', function (e) {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.file-row');

            rows.forEach(row => {
                const fileLink = row.querySelector('.file-link');
                if (fileLink) {
                    const dataName = fileLink.getAttribute('data-name');
                    const name = (dataName || '').toLowerCase();
                    if (name.includes(term)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        });
    }
</script>
{% endblock %}