{% extends "base.html" %}

{% block title %}服务器管理 - MailBridge{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">服务器管理</h1>
        <p class="page-subtitle">管理邮件附件上传的 WebDAV 服务器</p>
    </div>
    <button class="btn btn-primary" onclick="openAddModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" x2="12" y1="5" y2="19" />
            <line x1="5" x2="19" y1="12" y2="12" />
        </svg>
        添加服务器
    </button>
</div>

<div id="message" class="alert" style="display: none;"></div>

<div class="card">
    {% if servers %}
    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
        {% for server in servers %}
        <div class="server-item {% if server.name == default_server %}active-server{% endif %} {% if not server.enabled %}disabled-server{% endif %}"
            onclick="selectServer(event, '{{ server.name }}')"
            style="border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 1rem; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s;">

            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="radio-wrapper" style="display: flex; align-items: center;">
                    <input type="radio" name="default_server" value="{{ server.name }}" {% if
                        server.name==default_server %}checked{% endif %} {% if not server.enabled %}disabled{% endif %}
                        onclick="event.stopPropagation(); setDefaultServer('{{ server.name }}')"
                        style="width: 1.25rem; height: 1.25rem; accent-color: var(--primary-color); cursor: pointer;">
                </div>

                <div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                        <span style="font-weight: 600; font-size: 1rem;">{{ server.name }}</span>
                        {% if server.enabled %}
                        <span class="badge badge-success">启用</span>
                        {% else %}
                        <span class="badge badge-neutral">禁用</span>
                        {% endif %}

                        {% if server.name == default_server %}
                        <span class="badge badge-neutral"
                            style="background-color: var(--primary-color); color: white;">默认</span>
                        {% endif %}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem; font-family: var(--font-mono);">{{
                        server.url }}</div>
                </div>
            </div>

            <div class="server-actions" style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary btn-sm" data-id="{{ server.id }}" data-name="{{ server.name | e }}"
                    onclick="event.stopPropagation(); testServer(event, '{{ server.id }}')">
                    测试
                </button>
                <button class="btn btn-secondary btn-sm" data-id="{{ server.id }}" data-name="{{ server.name | e }}"
                    data-url="{{ server.url | e }}" data-login="{{ server.login | e }}"
                    data-password="{{ server.password | e }}" data-enabled="{{ server.enabled|lower }}"
                    data-priority="{{ server.priority }}" onclick="event.stopPropagation(); openEditModalWrapper(this)">
                    编辑
                </button>
                <button class="btn btn-danger btn-sm" data-id="{{ server.id }}" data-name="{{ server.name | e }}"
                    onclick="event.stopPropagation(); deleteServerWrapper(this)">
                    删除
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem 1rem; color: var(--text-muted);">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
            style="margin-bottom: 1rem; opacity: 0.5;">
            <rect width="20" height="8" x="2" y="2" rx="2" ry="2" />
            <rect width="20" height="8" x="2" y="14" rx="2" ry="2" />
            <line x1="6" x2="6.01" y1="6" y2="6" />
            <line x1="6" x2="6.01" y1="18" y2="18" />
        </svg>
        <p>暂无配置的 WebDAV 服务器</p>
        <p style="font-size: 0.875rem; margin-top: 0.5rem;">点击右上角"添加服务器"开始配置</p>
    </div>
    {% endif %}
</div>

<!-- Modal -->
<div id="serverModal"
    style="display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center;">
    <div class="card" style="width: 100%; max-width: 500px; margin: 2rem; animation: modalFadeIn 0.2s ease-out;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 id="modalTitle" style="font-size: 1.25rem; font-weight: 600;">添加服务器</h2>
            <button onclick="closeModal()"
                style="background: none; border: none; cursor: pointer; color: var(--text-secondary);">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" x2="6" y1="6" y2="18" />
                    <line x1="6" x2="18" y1="6" y2="18" />
                </svg>
            </button>
        </div>

        <form id="serverForm" onsubmit="submitServerForm(event)">
            <input type="hidden" id="serverId" value="">

            <div class="form-group">
                <label class="form-label">服务器名称 *</label>
                <input type="text" id="serverName" class="form-control" required placeholder="例如: Primary">
            </div>

            <div class="form-group">
                <label class="form-label">WebDAV URL *</label>
                <input type="text" id="serverUrl" class="form-control" required
                    placeholder="https://dav.example.com/remote.php/dav/files/user/">
            </div>

            <div class="form-group">
                <label class="form-label">用户名 *</label>
                <input type="text" id="serverLogin" class="form-control" required>
            </div>

            <div class="form-group">
                <label class="form-label">密码 *</label>
                <input type="password" id="serverPassword" class="form-control" required>
            </div>

            <div class="form-group">
                <label class="form-label">优先级 (数字越小优先级越高)</label>
                <input type="number" id="serverPriority" class="form-control" value="0">
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="serverEnabled" checked
                        style="width: 1rem; height: 1rem; accent-color: var(--primary-color);">
                    <span style="font-size: 0.875rem;">启用此服务器</span>
                </label>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
                <button type="submit" class="btn btn-primary">保存</button>
            </div>
        </form>
    </div>
</div>

<style>
    .server-item:hover {
        background-color: var(--bg-body);
        border-color: var(--border-focus) !important;
    }

    .active-server {
        background-color: #f0f9ff !important;
        border-color: var(--accent-color) !important;
    }

    .disabled-server {
        opacity: 0.6;
        background-color: #f9fafb;
    }

    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Modal Logic
    const modal = document.getElementById('serverModal');

    function openAddModal() {
        document.getElementById('modalTitle').textContent = '添加服务器';
        document.getElementById('serverId').value = '';
        document.getElementById('serverForm').reset();
        modal.style.display = 'flex';
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    // Close modal when clicking outside
    modal.addEventListener('click', function (e) {
        if (e.target === modal) {
            closeModal();
        }
    });

    function openEditModalWrapper(button) {
        const id = button.dataset.id;
        const name = button.dataset.name;
        const url = button.dataset.url;
        const login = button.dataset.login;
        const password = button.dataset.password;
        const enabled = button.dataset.enabled === 'true';
        const priority = button.dataset.priority;

        document.getElementById('modalTitle').textContent = '编辑服务器';
        document.getElementById('serverId').value = id;
        document.getElementById('serverName').value = name;
        document.getElementById('serverUrl').value = url;
        document.getElementById('serverLogin').value = login;
        document.getElementById('serverPassword').value = password;
        document.getElementById('serverEnabled').checked = enabled;
        document.getElementById('serverPriority').value = priority;

        modal.style.display = 'flex';
    }

    // Server Actions
    function selectServer(event, serverName) {
        // Don't trigger if clicking buttons
        if (event.target.tagName === 'BUTTON' || event.target.closest('button')) return;

        const radio = event.currentTarget.querySelector('input[type="radio"]');
        if (radio && !radio.disabled) {
            radio.checked = true;
            setDefaultServer(serverName);

            // Update UI visually
            document.querySelectorAll('.server-item').forEach(i => i.classList.remove('active-server'));
            event.currentTarget.classList.add('active-server');
        }
    }

    async function setDefaultServer(serverName) {
        try {
            const formData = new FormData();
            formData.append('server_name', serverName);

            const response = await fetch('/servers/set-default', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            showMessage(data.status, data.message);

            if (data.status === 'success') {
                setTimeout(() => location.reload(), 500);
            }

        } catch (error) {
            showMessage('error', '保存失败: ' + error.message);
        }
    }

    async function submitServerForm(event) {
        event.preventDefault();

        const serverId = document.getElementById('serverId').value;
        const isEdit = serverId !== '';

        const data = {
            name: document.getElementById('serverName').value,
            url: document.getElementById('serverUrl').value,
            login: document.getElementById('serverLogin').value,
            password: document.getElementById('serverPassword').value,
            enabled: document.getElementById('serverEnabled').checked,
            priority: parseInt(document.getElementById('serverPriority').value)
        };

        try {
            const url = isEdit ? `/servers/edit/${serverId}` : '/servers/add';
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            showMessage(result.status, result.message);

            if (result.status === 'success') {
                closeModal();
                setTimeout(() => location.reload(), 1000);
            }

        } catch (error) {
            showMessage('error', '操作失败: ' + error.message);
        }
    }

    async function deleteServerWrapper(button) {
        const id = button.dataset.id;
        const name = button.dataset.name;

        if (!confirm(`确定要删除服务器 "${name}" 吗？此操作不可恢复！`)) {
            return;
        }

        try {
            const response = await fetch(`/servers/delete/${id}`, {
                method: 'POST'
            });

            const result = await response.json();
            showMessage(result.status, result.message);

            if (result.status === 'success') {
                setTimeout(() => location.reload(), 1000);
            }

        } catch (error) {
            showMessage('error', '删除失败: ' + error.message);
        }
    }

    async function testServer(event, serverId) {
        event.stopPropagation();
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> 测试中...';

        fetch(`/servers/test/${serverId}`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                showToast('测试请求失败: ' + error, 'error');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
    }

    function showMessage(status, message) {
        const messageEl = document.getElementById('message');
        messageEl.className = `alert alert-${status === 'success' ? 'success' : 'error'}`;
        messageEl.textContent = message;
        messageEl.style.display = 'flex';

        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 3000);
    }
</script>
{% endblock %}